<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM æ–‡æœ¬å¤„ç†å™¨</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #1a1a2e; color: #fff; min-height: 100vh; }
        header { background: #16213e; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        header h1 { font-size: 18px; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: #2a2a3e; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; max-height: 85vh; overflow-y: auto; }
        .modal h2 { margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; color: #9ca3af; font-size: 13px; }
        .form-group input, .form-group select { width: 100%; padding: 10px; background: #1a1a2e; border: 1px solid #3f3f5a; border-radius: 6px; color: #fff; font-size: 14px; }
        .test-result { margin-top: 10px; padding: 10px; border-radius: 6px; font-size: 13px; }
        .test-result.success { background: #065f46; color: #34d399; }
        .test-result.error { background: #7f1d1d; color: #fca5a5; }
        .test-result.info { background: #1e3a5f; color: #60a5fa; }
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        .modal-btns button { flex: 1; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #10b981; color: #fff; }
        .btn-secondary { background: #4b5563; color: #fff; }
        .btn-test { background: #f59e0b; color: #fff; }
        .container { display: flex; gap: 15px; padding: 20px; height: calc(100vh - 200px); }
        .panel { flex: 1; background: #2a2a3e; border-radius: 12px; padding: 15px; display: flex; flex-direction: column; }
        .panel-title { font-size: 14px; font-weight: bold; margin-bottom: 12px; }
        textarea { flex: 1; background: #1a1a2e; border: none; border-radius: 8px; padding: 12px; color: #fff; resize: none; font-size: 14px; line-height: 1.6; }
        textarea::placeholder { color: #6b7280; }
        .cat-btns { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
        .cat-btn { padding: 6px 12px; border: none; border-radius: 20px; color: #fff; font-size: 12px; cursor: pointer; }
        .cat-btn:hover { transform: scale(1.05); }
        .input-area { background: #2a2a3e; padding: 15px 20px; }
        .input-area label { display: block; margin-bottom: 8px; color: #9ca3af; }
        .action-btn { background: #6366f1; color: #fff; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin-top: 10px; font-size: 14px; }
        .header-btn { background: #6366f1; color: #fff; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; margin-left: 10px; }
        .note { background: #1e3a5f; padding: 10px; border-radius: 6px; font-size: 12px; color: #60a5fa; margin-bottom: 15px; }
        .tab-btns { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; background: #4b5563; color: #fff; }
        .tab-btn.active { background: #6366f1; }
        .img-preview { max-width: 100%; max-height: 150px; border-radius: 8px; margin: 10px 0; display: none; }
        .img-preview.active { display: block; }
    </style>
</head>
<body>
    <header>
        <h1>ğŸ¤– LLM æ–‡æœ¬å¤„ç†å™¨</h1>
        <button class="header-btn" onclick="showConfig()">âš™ï¸ é…ç½®</button>
    </header>
    
    <!-- Tab -->
    <div style="padding:15px 20px 0;">
        <div class="tab-btns">
            <button class="tab-btn active" onclick="switchTab('text')" id="tabText">ğŸ“ æ–‡æœ¬å¤„ç†</button>
            <button class="tab-btn" onclick="switchTab('image')" id="tabImage">ğŸ–¼ï¸ å›¾ç‰‡åˆ†æ</button>
        </div>
    </div>
    
    <div class="container">
        <!-- ç¬¬ä¸€å—ï¼šAIæ‘˜è¦ï¼ˆåªæ˜¾ç¤ºï¼Œä¸æ›¿æ¢åŸæ–‡ï¼‰ -->
        <div class="panel">
            <div class="panel-title">ğŸ“ AI æ‘˜è¦ <span id="summaryStatus"></span></div>
            <textarea id="summary" readonly placeholder="ç‚¹å‡»ã€ŒAI æ‘˜è¦ã€ç”Ÿæˆæ‘˜è¦..."></textarea>
            <button class="action-btn" onclick="generateSummary()">ğŸ¤– ç”Ÿæˆæ‘˜è¦</button>
        </div>
        
        <!-- ç¬¬äºŒå—ï¼šåˆ†ç±»ï¼ˆç‚¹å‡»è·³è½¬åˆ°å¯¹åº”æ®µè½ï¼‰ -->
        <div class="panel">
            <div class="panel-title">ğŸ·ï¸ æ™ºèƒ½åˆ†ç±» <span id="classifyStatus"></span></div>
            <div id="aiCategories" class="cat-btns"></div>
            <textarea id="classified" placeholder="AI åˆ†ç±»åçš„å†…å®¹ï¼Œç‚¹å‡»ä¸Šæ–¹åˆ†ç±»æ ‡ç­¾å¯è·³è½¬..."></textarea>
            <button class="action-btn" onclick="classifyText()" style="background:#8b5cf6">ğŸ”® æ™ºèƒ½åˆ†ç±»</button>
        </div>
        
        <!-- ç¬¬ä¸‰å—ï¼šç¼–è¾‘ï¼ˆä¸ç¬¬äºŒå—åŒæ­¥æ»šåŠ¨ï¼Œå¯ç¼–è¾‘ï¼‰ -->
        <div class="panel">
            <div class="panel-title">âœï¸ æœ€ç»ˆå†…å®¹ <span style="font-size:12px;color:#9ca3af">(ä¸ä¸Šæ–¹åŒæ­¥)</span></div>
            <textarea id="final" placeholder="ç¼–è¾‘æœ€ç»ˆå†…å®¹ï¼Œå¯ä¸åˆ†ç±»å†…å®¹å¯¹æ¯”..." onscroll="syncScroll(this)"></textarea>
            <button class="action-btn" onclick="exportContent()">ğŸ“¥ å¯¼å‡º</button>
        </div>
    </div>
    
    <!-- æ–‡æœ¬è¾“å…¥åŒº -->
    <div class="input-area" id="textInputArea">
        <label>ğŸ“„ è¾“å…¥åŸæ–‡:</label>
        <textarea id="inputText" style="height:70px" placeholder="åœ¨è¿™é‡Œè¾“å…¥è¦å¤„ç†çš„æ–‡æœ¬..."></textarea>
    </div>
    
    <!-- å›¾ç‰‡è¾“å…¥åŒº -->
    <div class="input-area" id="imageInputArea" style="display:none;">
        <label>ğŸ–¼ï¸ é€‰æ‹©å›¾ç‰‡:</label>
        <input type="file" id="imageFile" accept="image/*" onchange="previewImage()" style="margin:10px 0;">
        <img id="imgPreview" class="img-preview">
        <textarea id="imageQuestion" style="height:50px" placeholder="è¾“å…¥ä½ æƒ³é—®å›¾ç‰‡çš„é—®é¢˜..."></textarea>
    </div>
    
    <!-- é…ç½®å¼¹çª— -->
    <div class="modal" id="configModal">
        <div class="modal-content">
            <h2>ğŸ¤– LLM API é…ç½®</h2>
            <div class="note">ğŸ’¡ é€‰æ‹©æœåŠ¡å•† â†’ å¡« API Key â†’ é€‰æ‹©æ¨¡å‹ â†’ ä¿å­˜</div>
            <div class="form-group">
                <label>é€‰æ‹©æœåŠ¡å•†</label>
                <select id="provider" onchange="showFields()">
                    <option value="DeepSeek">DeepSeek</option>
                    <option value="OpenAI">OpenAI</option>
                    <option value="Moonshot">Moonshot</option>
                    <option value="Zhipu">æ™ºè°±AI</option>
                    <option value="Ollama">Ollama</option>
                </select>
            </div>
            <div id="fields"></div>
            <div id="testResult" class="test-result" style="display:none;"></div>
            <div class="modal-btns">
                <button class="btn-test" onclick="testConnection()">ğŸ§ª æµ‹è¯•</button>
                <button class="btn-secondary" onclick="hideConfig()">å–æ¶ˆ</button>
                <button class="btn-primary" onclick="saveConfig()">ğŸ’¾ ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <script>
        let config = JSON.parse(localStorage.getItem('llm_config') || '{}');
        let currentProvider = localStorage.getItem('llm_current_provider') || 'DeepSeek';
        let currentTab = 'text';
        let imageBase64 = '';
        let classifiedSegments = [];
        
        const providers = {
            'DeepSeek': { fields: [{key:'api_key',label:'API Key',type:'password'},{key:'model',label:'é€‰æ‹©æ¨¡å‹',options:['deepseek-chat','deepseek-coder']}], endpoint:'https://api.deepseek.com/v1/chat/completions' },
            'OpenAI': { fields: [{key:'api_key',label:'API Key',type:'password'},{key:'model',label:'é€‰æ‹©æ¨¡å‹',options:['gpt-4o','gpt-4-turbo']}], endpoint:'https://api.openai.com/v1/chat/completions' },
            'Moonshot': { fields: [{key:'api_key',label:'API Key',type:'password'},{key:'model',label:'é€‰æ‹©æ¨¡å‹',options:['moonshot-v1-8k-vision-preview']}], endpoint:'https://api.moonshot.cn/v1/chat/completions' },
            'Zhipu': { fields: [{key:'api_key',label:'API Key',type:'password'},{key:'model',label:'é€‰æ‹©æ¨¡å‹',options:['glm-4','glm-4v']}], endpoint:'https://open.bigmodel.cn/api/paas/v4/chat/completions' },
            'Ollama': { fields: [{key:'base_url',label:'æœ¬åœ°åœ°å€',default:'http://localhost:11434'},{key:'model',label:'é€‰æ‹©æ¨¡å‹',options:['llama3','llava']}], endpoint:'', isOllama:true }
        };
        
        const catColors = ['#ef4444','#f59e0b','#10b981','#3b82f6','#8b5cf6','#ec4899'];
        
        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('tabText').className = tab === 'text' ? 'tab-btn active' : 'tab-btn';
            document.getElementById('tabImage').className = tab === 'image' ? 'tab-btn active' : 'tab-btn';
            document.getElementById('textInputArea').style.display = tab === 'text' ? 'block' : 'none';
            document.getElementById('imageInputArea').style.display = tab === 'image' ? 'block' : 'none';
        }
        
        function previewImage() {
            const file = document.getElementById('imageFile').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                imageBase64 = e.target.result.split(',')[1];
                document.getElementById('imgPreview').src = e.target.result;
                document.getElementById('imgPreview').className = 'img-preview active';
            };
            reader.readAsDataURL(file);
        }
        
        function showConfig() {
            document.getElementById('provider').value = currentProvider;
            document.getElementById('configModal').classList.add('active');
            showFields();
        }
        
        function hideConfig() { document.getElementById('configModal').classList.remove('active'); }
        
        function showFields() {
            currentProvider = document.getElementById('provider').value;
            const p = providers[currentProvider];
            const container = document.getElementById('fields');
            container.innerHTML = p.fields.map(f => {
                if (f.options) {
                    return `<div class="form-group"><label>${f.label}</label><select id="field_${f.key}">${f.options.map(o=>`<option value="${o}" ${(config[currentProvider]?.[f.key]||f.options[0])===o?'selected':''}>${o}</option>`).join('')}</select></div>`;
                } else {
                    return `<div class="form-group"><label>${f.label}</label><input type="${f.type||'text'}" id="field_${f.key}" value="${config[currentProvider]?.[f.key]||f.default||''}"></div>`;
                }
            }).join('');
        }
        
        function saveConfig() {
            const provider = document.getElementById('provider');
            if (!config[provider.value]) config[provider.value] = {};
            providers[provider.value].fields.forEach(f => {
                config[provider.value][f.key] = document.getElementById('field_' + f.key).value;
            });
            localStorage.setItem('llm_config', JSON.stringify(config));
            localStorage.setItem('llm_current_provider', provider.value);
            hideConfig();
        }
        
        async function callAI(prompt, systemPrompt = 'ä½ æ˜¯ä¸€ä¸ªæœ‰å¸®åŠ©çš„AI') {
            const conf = config[currentProvider];
            const p = providers[currentProvider];
            if (!conf || (!conf.api_key && !conf.base_url)) throw new Error('è¯·å…ˆé…ç½®API');
            
            if (currentProvider === 'Ollama') {
                const response = await fetch(`${conf.base_url}/api/generate`, {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({model: conf.model, prompt: prompt, stream: false})
                });
                const data = await response.json();
                return data.response;
            }
            
            let headers = {'Content-Type':'application/json'};
            if (currentProvider === 'OpenAI') headers['Authorization'] = `Bearer ${conf.api_key}`;
            else if (currentProvider === 'DeepSeek') headers['Authorization'] = `Bearer ${conf.api_key}`;
            else if (currentProvider === 'Moonshot') headers['Authorization'] = `Bearer ${conf.api_key}`;
            else if (currentProvider === 'Zhipu') headers['Authorization'] = `Bearer ${conf.api_key}`;
            
            const response = await fetch(p.endpoint, {
                method:'POST', headers: headers,
                body: JSON.stringify({
                    model: conf.model,
                    messages: [{role:'system',content:systemPrompt},{role:'user',content:prompt}]
                })
            });
            const data = await response.json();
            if (data.choices && data.choices[0]) return data.choices[0].message.content;
            throw new Error(JSON.stringify(data));
        }
        
        async function generateSummary() {
            const text = document.getElementById('inputText').value;
            if (!text) { alert('è¯·å…ˆè¾“å…¥æ–‡æœ¬'); return; }
            
            document.getElementById('summaryStatus').innerHTML = '<span style="color:#f59e0b">å¤„ç†ä¸­...</span>';
            try {
                const result = await callAI(`è¯·ä¸ºä»¥ä¸‹æ–‡æœ¬ç”Ÿæˆç®€æ´æ‘˜è¦ï¼ˆ80å­—ä»¥å†…ï¼‰ï¼š\n\n${text}`, 'ä½ æ˜¯æ–‡æœ¬æ‘˜è¦ä¸“å®¶');
                document.getElementById('summary').value = result;
                document.getElementById('summaryStatus').innerHTML = '<span style="color:#10b981">âœ“</span>';
            } catch(e) {
                document.getElementById('summary').value = 'é”™è¯¯: ' + e.message;
                document.getElementById('summaryStatus').innerHTML = '<span style="color:#ef4444">âœ—</span>';
            }
        }
        
        async function classifyText() {
            const text = document.getElementById('inputText').value;
            if (!text) { alert('è¯·å…ˆè¾“å…¥æ–‡æœ¬'); return; }
            
            document.getElementById('classifyStatus').innerHTML = '<span style="color:#f59e0b">å¤„ç†ä¸­...</span>';
            try {
                const prompt = `è¯·åˆ†æä»¥ä¸‹æ–‡æœ¬ï¼Œæå–3-5ä¸ªåˆ†ç±»æ ‡ç­¾å’Œå¯¹åº”å†…å®¹ã€‚\næ ¼å¼ï¼š\nã€æ ‡ç­¾1ã€‘\nå¯¹åº”çš„å†…å®¹ç‰‡æ®µ\n---\nã€æ ‡ç­¾2ã€‘\nå¯¹åº”å†…å®¹\n\nåŸæ–‡ï¼š${text}`;
                const result = await callAI(prompt, 'ä½ æ˜¯æ–‡æœ¬åˆ†ç±»ä¸“å®¶ï¼ŒæŒ‰æ ¼å¼è¾“å‡º');
                
                // è§£æåˆ†ç±»ç»“æœ
                classifiedSegments = [];
                const lines = result.split('\n');
                let currentCat = '';
                let currentContent = '';
                
                lines.forEach(line => {
                    if (line.startsWith('ã€') && line.includes('ã€‘')) {
                        if (currentCat && currentContent) {
                            classifiedSegments.push({category: currentCat.replace('ã€','').replace('ã€‘',''), content: currentContent.trim()});
                        }
                        currentCat = line;
                        currentContent = '';
                    } else if (line === '---') {
                        // skip
                    } else {
                        currentContent += line + '\n';
                    }
                });
                if (currentCat && currentContent) {
                    classifiedSegments.push({category: currentCat.replace('ã€','').replace('ã€‘',''), content: currentContent.trim()});
                }
                
                // æ˜¾ç¤ºåœ¨ç¬¬äºŒå—
                document.getElementById('classified').value = result;
                document.getElementById('final').value = result;  // åŒæ­¥åˆ°ç¬¬ä¸‰å—
                
                // ç”Ÿæˆåˆ†ç±»æŒ‰é’®ï¼ˆå¯ç‚¹å‡»è·³è½¬ï¼‰
                const catContainer = document.getElementById('aiCategories');
                catContainer.innerHTML = classifiedSegments.map((seg, i) => 
                    `<button class="cat-btn" style="background:${catColors[i%catColors.length]}" onclick="jumpToSegment(${i})">${seg.category}</button>`
                ).join('');
                
                document.getElementById('classifyStatus').innerHTML = '<span style="color:#10b981">âœ“</span>';
            } catch(e) {
                document.getElementById('classified').value = 'é”™è¯¯: ' + e.message;
                document.getElementById('classifyStatus').innerHTML = '<span style="color:#ef4445">âœ—</span>';
            }
        }
        
        // ç‚¹å‡»åˆ†ç±»æ ‡ç­¾è·³è½¬åˆ°å¯¹åº”æ®µè½
        function jumpToSegment(index) {
            const textarea = document.getElementById('classified');
            const content = textarea.value;
            const targetText = classifiedSegments[index]?.content;
            
            if (!targetText) return;
            
            const pos = content.indexOf(targetText);
            if (pos >= 0) {
                textarea.focus();
                textarea.setSelectionRange(pos, pos + targetText.length);
            }
        }
        
        // åŒæ­¥æ»šåŠ¨ï¼šç¬¬äºŒå—æ»šåŠ¨æ—¶ç¬¬ä¸‰å—åŒæ­¥
        function syncScroll(source) {
            const target = source.id === 'final' ? document.getElementById('classified') : document.getElementById('final');
            target.scrollTop = source.scrollTop;
        }
        
        // ç¬¬ä¸‰å—æ»šåŠ¨æ—¶ç¬¬äºŒå—åŒæ­¥
        document.getElementById('classified').addEventListener('scroll', function() {
            document.getElementById('final').scrollTop = this.scrollTop;
        });
        
        async function testConnection() {
            const conf = config[currentProvider];
            const result = document.getElementById('testResult');
            if (!conf || (!conf.api_key && !conf.base_url)) {
                result.className = 'test-result error';
                result.textContent = 'è¯·å…ˆå¡«å†™API Key';
                result.style.display = 'block';
                return;
            }
            result.className = 'test-result info';
            result.textContent = 'æ­£åœ¨æµ‹è¯•...';
            result.style.display = 'block';
            try {
                const r = await callAI('è¯´"æµ‹è¯•æˆåŠŸ"', 'ç”¨ä¸€å¥è¯å›å¤');
                result.className = 'test-result success';
                result.innerHTML = 'âœ… æˆåŠŸï¼å›å¤: ' + r.substring(0,50);
            } catch(e) {
                result.className = 'test-result error';
                result.textContent = 'âŒ å¤±è´¥: ' + e.message;
            }
        }
        
        function exportContent() {
            const content = document.getElementById('final').value;
            if (!content) { alert('æ²¡æœ‰å¯å¯¼å‡ºçš„å†…å®¹'); return; }
            const blob = new Blob([content], {type:'text/plain;charset=utf-8'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `LLMå¤„ç†_${new Date().getTime()}.txt`;
            a.click();
        }
        
        showFields();
    </script>
</body>
</html>
